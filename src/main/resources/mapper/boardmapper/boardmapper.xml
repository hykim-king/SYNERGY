<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pcwk.ehr.mapper.BoardMapper">

    <!-- 게시글 검색 (페이징 포함) -->
    <select id="doRetrieve" parameterType="com.pcwk.ehr.cmn.SearchDTO" resultType="com.pcwk.ehr.board.BoardDTO">
        SELECT A.*, B.*
        FROM (
            SELECT tt3.rnum AS no,
                   tt3.board_code,
                   tt3.title,
                   tt3.contents,
                   tt3.id,
                   tt3.nickname,
                   tt3.read_cnt,
                   TO_CHAR(tt3.reg_dt, 'YYYY/MM/DD HH24:MI:SS') AS reg_dt,
                   tt3.reg_id,
                   TO_CHAR(tt3.mod_dt, 'YYYY/MM/DD HH24:MI:SS') AS mod_dt,
                   tt3.mod_id
            FROM (
                SELECT ROWNUM AS rnum, tt2.*
                FROM (
                    SELECT t1.*
                    FROM BOARD t1
                    <where>
                        <if test="searchDiv != null and searchDiv != ''">
                            <choose>
                                <when test="searchDiv == '10'">
                                    title LIKE '%' || #{searchWord} || '%'
                                </when>
                                <when test="searchDiv == '20'">
                                    contents LIKE '%' || #{searchWord} || '%'
                                </when>
                                <when test="searchDiv == '30'">
                                    id LIKE '%' || #{searchWord} || '%'
                                </when>
                            </choose>
                        </if>
                    </where>
                    ORDER BY t1.board_code DESC
                ) tt2
                <![CDATA[
                WHERE ROWNUM <= (#{pageSize} * (#{pageNo} - 1) + #{pageSize})
                ]]>
            ) tt3
            <![CDATA[
            WHERE rnum >= (#{pageSize} * (#{pageNo} - 1) + 1)
            ]]>
        ) A
        CROSS JOIN (
            SELECT COUNT(*) AS total_cnt
            FROM BOARD
            <where>
                <if test="searchDiv != null and searchDiv != ''">
                    <choose>
                        <when test="searchDiv == '10'">
                            title LIKE '%' || #{searchWord} || '%'
                        </when>
                        <when test="searchDiv == '20'">
                            contents LIKE '%' || #{searchWord} || '%'
                        </when>
                        <when test="searchDiv == '30'">
                            id LIKE '%' || #{searchWord} || '%'
                        </when>
                    </choose>
                </if>
            </where>
        ) B
    </select>

    <!-- 게시글 등록 -->
    <insert id="doSave" parameterType="BoardDTO">
    <selectKey keyProperty="boardCode" resultType="int" order="BEFORE">
        SELECT BOARD_SEQ.NEXTVAL FROM DUAL
    </selectKey>
    INSERT INTO BOARD (
        BOARD_CODE,
        TITLE,
        CONTENTS,
        ID,
        NICKNAME,
        READ_CNT,
        REG_DT,
        REG_ID,
        MOD_DT,
        MOD_ID
    ) VALUES (
        #{boardCode},
        #{title},
        #{contents},
        #{id},
        #{nickname},
        0,
        SYSDATE,
        #{regId},
        SYSDATE,
        #{modId}
    )
</insert>
    <!-- 게시글 삭제 -->
    <delete id="doDelete" parameterType="com.pcwk.ehr.board.BoardDTO">
        DELETE FROM BOARD
        WHERE board_code = #{boardCode}
    </delete>

    <!-- 게시글 단건 조회 -->
    <resultMap type="com.pcwk.ehr.board.BoardDTO" id="boardMap">
        <id column="board_code" property="boardCode"/>
        <result column="title" property="title"/>
        <result column="contents" property="contents"/>
        <result column="id" property="id"/>
        <result column="nickname" property="nickname"/>
        <result column="read_cnt" property="readCnt"/>
        <result column="reg_dt" property="regDt"/>
        <result column="reg_id" property="regId"/>
        <result column="mod_dt" property="modDt"/>
        <result column="mod_id" property="modId"/>
    </resultMap>

    <select id="doSelectOne" parameterType="com.pcwk.ehr.board.BoardDTO" resultMap="boardMap">
        SELECT *
        FROM BOARD
        WHERE board_code = #{boardCode}
    </select>

    <!-- 게시글 전체 조회 -->
    <select id="getAll" resultType="com.pcwk.ehr.board.BoardDTO">
        SELECT *
        FROM BOARD
        ORDER BY board_code DESC
    </select>

    <!-- 전체 게시글 수 -->
    <select id="getCount" resultType="int">
        SELECT COUNT(*) AS totalCnt FROM BOARD
    </select>

    <!-- 테스트용 샘플 데이터 저장 -->
    <insert id="saveAll">
        INSERT INTO BOARD (
            BOARD_CODE,
            TITLE,
            CONTENTS,
            ID,
            NICKNAME,
            READ_CNT,
            REG_DT,
            REG_ID,
            MOD_DT,
            MOD_ID
        )
        SELECT BOARD_SEQ.NEXTVAL,
               '제목' || LEVEL,
               '내용' || LEVEL,
               'user' || LEVEL,
               '별명' || LEVEL,
               0,
               SYSDATE,
               'regUser',
               SYSDATE,
               'modUser'
        FROM DUAL
       <![CDATA[ CONNECT BY LEVEL <= 10]]>
    </insert>

    <!-- 전체 게시글 삭제 -->
    <delete id="deleteAll">
        DELETE FROM BOARD
    </delete>

</mapper>